//field_x86.saw Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0

///////////////////////////////////////////////////////////////////////////////
// Verify the x86 field operations

///////////////////////////////////////////////////////////////////////////////
// Specifications

let asm_globals =
  [ ("asm_p434", 56)
  , ("asm_p434p1", 56)
  , ("asm_p434x2", 56)
  ];

let verify_asm func spec =
    if do_prove then
        crucible_llvm_verify_x86 m "../../../../lib/libs2n.so" func asm_globals spec
    else
        crucible_llvm_unsafe_assume_spec m func spec;

let mp_subadd434x2_asm_left_spec = do {
    a <- crucible_alloc f2elm_t;
    a_star <- crucible_fresh_var "a" f2elm_t;
    crucible_points_to a (crucible_term a_star);

    b <- crucible_alloc_readonly f2elm_t;
    b_star <- crucible_fresh_var "b" f2elm_t;
    crucible_points_to b (crucible_term b_star);

    crucible_execute_func [a, b, a];

    a_star <- crucible_fresh_var "a" f2elm_t;
    crucible_points_to a (crucible_term a_star);
};

let mp_add434_asm_spec = do {
    a <- crucible_alloc_readonly felm_t;
    a_star <- crucible_fresh_var "a" felm_t;
    crucible_points_to a (crucible_term a_star);

    b <- crucible_alloc_readonly felm_t;
    b_star <- crucible_fresh_var "b" felm_t;
    crucible_points_to b (crucible_term b_star);

    c <- crucible_alloc felm_t;

    crucible_execute_func [a, b, c];

    c_star <- crucible_fresh_var "c" felm_t;
    crucible_points_to c (crucible_term c_star);
};

///////////////////////////////////////////////////////////////////////////////
// Proof commands

fpzero503_ov <- verify fpzero_fun_name [] fpzero503_spec;
fpcopy503_ov <- verify fpcopy_fun_name [] fpcopy503_spec;
fpcorrection503_ov <- verify fpcorrection_fun_name [] fpcorrection503_spec;

fpneg503_ov <- verify fpneg_fun_name [] fpneg503_spec;

fpadd503_asm_ov <- verify_asm "fpadd434_asm" fpadd503_spec;
fpadd503_ov <- verify fpadd_fun_name [fpadd503_asm_ov] fpadd503_spec;

fpadd503_asm_left_ov <- verify_asm "fpadd434_asm" fpadd503_left_spec;
fpadd503_left_ov <- verify fpadd_fun_name [fpadd503_asm_left_ov] fpadd503_left_spec;

fpadd503_asm_right_ov <- verify_asm "fpadd434_asm" fpadd503_right_spec;
fpadd503_right_ov <- verify fpadd_fun_name [fpadd503_asm_right_ov] fpadd503_right_spec;

fpadd503_asm_same_ov <- verify_asm "fpadd434_asm" fpadd503_same_spec;
fpadd503_same_ov <- verify fpadd_fun_name [fpadd503_asm_same_ov] fpadd503_same_spec;

fpadd503_asm_pair_ov <- verify_asm "fpadd434_asm" fpadd503_pair_spec;
fpadd503_pair_ov <- verify fpadd_fun_name [fpadd503_asm_pair_ov] fpadd503_pair_spec;

fpsub503_asm_ov <- verify_asm "fpsub434_asm" fpsub503_spec;
fpsub503_ov <- verify fpsub_fun_name [fpsub503_asm_ov] fpsub503_spec;

fpsub503_asm_left_ov <- verify_asm "fpsub434_asm" fpsub503_left_spec;
fpsub503_left_ov <- verify fpsub_fun_name [fpsub503_asm_left_ov] fpsub503_left_spec;

fpsub503_asm_right_ov <- verify_asm "fpsub434_asm" fpsub503_right_spec;
fpsub503_right_ov <- verify fpsub_fun_name [fpsub503_asm_right_ov] fpsub503_right_spec;

fpsub503_asm_same_ov <- verify_asm "fpsub434_asm" fpsub503_same_spec;
fpsub503_same_ov <- verify fpsub_fun_name [fpsub503_asm_same_ov] fpsub503_same_spec;

fpdiv2_503_ov <- verify fpdiv2_fun_name [] fpdiv2_503_spec;
fpdiv2_503_same_ov <- verify fpdiv2_fun_name [] fpdiv2_503_same_spec;

rdc_mont_asm_ov <- verify_asm "rdc434_asm" rdc_mont_spec;
rdc_mont_ov <- verify rdc_mont_fun_name [rdc_mont_asm_ov] rdc_mont_spec;

mul_asm_ov <- verify_asm "mul434_asm" (mp_mul_spec nwords_field twice_nwords_field);
mul_ov <- verify mp_mul_fun_name [mul_asm_ov] (mp_mul_spec nwords_field twice_nwords_field);

fpmul503_mont_ov <- verify fpmul_mont_fun_name
    [ rdc_mont_ov
    , mul_asm_ov
    ]
    fpmul503_mont_spec;

fpmul503_mont_left_ov <- verify fpmul_mont_fun_name
    [ rdc_mont_ov
    , mul_asm_ov
    ]
    fpmul503_mont_left_spec;

fpmul503_mont_right_ov <- verify fpmul_mont_fun_name
    [ rdc_mont_ov
    , mul_asm_ov
    ]
    fpmul503_mont_right_spec;

fpmul503_mont_same_ov <- verify fpmul_mont_fun_name
    [ rdc_mont_ov
    , mul_asm_ov
    ]
    fpmul503_mont_same_spec;

mul_asm_single_ov <- verify_asm "mul434_asm"
    (mp_mul_single_spec nwords_field twice_nwords_field);

mul_single_ov <- verify mp_mul_fun_name
    [mul_asm_single_ov] (mp_mul_single_spec nwords_field twice_nwords_field);

fpsqr503_mont_ov <- verify fpsqr_mont_fun_name
    [ mul_asm_single_ov
    , rdc_mont_ov
    ]
    fpsqr503_mont_spec;

fpsqr503_mont_same_ov <- verify fpsqr_mont_fun_name
    [ mul_asm_single_ov
    , rdc_mont_ov
    ]
    fpsqr503_mont_same_spec;

fpinv503_chain_mont_ov <- verify fpinv_chain_mont_fun_name
    [ fpmul503_mont_ov
    , fpmul503_mont_right_ov
    , fpsqr503_mont_ov
    , fpsqr503_mont_same_ov
    , fpcopy503_ov
    ]
    fpinv503_chain_mont_spec;

fpinv503_mont_ov <- verify fpinv_mont_fun_name
    [ fpcopy503_ov
    , fpinv503_chain_mont_ov
    , fpsqr503_mont_same_ov
    , fpmul503_mont_left_ov
    ]
    fpinv503_mont_spec;

to_mont_ov <- verify to_mont_fun_name
    [fpmul503_mont_ov]
    to_mont_spec;
to_mont_same_ov <- verify to_mont_fun_name
    [fpmul503_mont_left_ov]
    to_mont_same_spec;

from_mont_ov <- verify from_mont_fun_name
    [ fpmul503_mont_ov
    , fpcorrection503_ov
    ]
    from_mont_spec;

fp2copy503_ov <- verify fp2copy_fun_name
    [fpcopy503_ov] fp2copy503_spec;

fp2correction503_ov <- verify fp2correction_fun_name
    [fpcorrection503_ov] fp2correction503_spec;

fp2neg503_ov <- verify fp2neg_fun_name
    [fpneg503_ov]
    fp2neg503_spec;

fp2add503_ov <- verify fp2add_fun_name
    [fpadd503_ov] fp2add503_spec;
fp2add503_left_ov <- verify fp2add_fun_name
    [fpadd503_left_ov] fp2add503_left_spec;
fp2add503_right_ov <- verify fp2add_fun_name
    [fpadd503_right_ov] fp2add503_right_spec;
fp2add503_same_ov <- verify fp2add_fun_name
    [fpadd503_same_ov] fp2add503_same_spec;
fp2add503_pair_ov <- verify fp2add_fun_name
    [fpadd503_pair_ov] fp2add503_pair_spec;

fp2sub503_ov <- verify fp2sub_fun_name
    [fpsub503_ov] fp2sub503_spec;
fp2sub503_left_ov <- verify fp2sub_fun_name
    [fpsub503_left_ov] fp2sub503_left_spec;
fp2sub503_right_ov <- verify fp2sub_fun_name
    [fpsub503_right_ov] fp2sub503_right_spec;
fp2sub503_same_ov <- verify fp2sub_fun_name
    [fpsub503_same_ov] fp2sub503_same_spec;

fp2div2_503_ov <- verify fp2div2_fun_name
    [fpdiv2_503_ov] fp2div2_503_spec;
fp2div2_503_same_ov <- verify fp2div2_fun_name
    [fpdiv2_503_same_ov] fp2div2_503_same_spec;

mp_add434_asm_ov <- verify_asm "mp_add434_asm" mp_add434_asm_spec;

mp_subadd434x2_asm_left_ov <- verify_asm "mp_subadd434x2_asm" mp_subadd434x2_asm_left_spec;

let mp_dblsub434x2_asm_spec = do {
  a <- crucible_alloc_readonly f2elm_t;
  a_star <- crucible_fresh_var "a" f2elm_t;
  crucible_points_to a (crucible_term a_star);

  b <- crucible_alloc_readonly f2elm_t;
  b_star <- crucible_fresh_var "b" f2elm_t;
  crucible_points_to b (crucible_term b_star);

  c <- crucible_alloc f2elm_t;
  c_star <- crucible_fresh_var "c" f2elm_t;
  crucible_points_to c (crucible_term c_star);

  crucible_execute_func [a, b, c];

  c_star <- crucible_fresh_var "c" f2elm_t;
  crucible_points_to c (crucible_term c_star);
};
mp_dblsub434x2_asm_ov <- verify_asm "mp_dblsub434x2_asm" mp_dblsub434x2_asm_spec;

fp2mul503_mont_ov <- verify fp2mul_mont_fun_name
    [ rdc_mont_ov
    , mul_asm_ov
    , mp_add434_asm_ov
    , mp_subadd434x2_asm_left_ov
    , mp_dblsub434x2_asm_ov
    ]
    fp2mul503_mont_spec;

fp2mul503_mont_left_ov <- verify fp2mul_mont_fun_name
    [ rdc_mont_ov
    , mul_asm_ov
    , mp_add434_asm_ov
    , mp_subadd434x2_asm_left_ov
    , mp_dblsub434x2_asm_ov
    ]
    fp2mul503_mont_left_spec;

fp2mul503_mont_right_ov <- verify fp2mul_mont_fun_name
    [ rdc_mont_ov
    , mul_asm_ov
    , mp_add434_asm_ov
    , mp_subadd434x2_asm_left_ov
    , mp_dblsub434x2_asm_ov
    ]
    fp2mul503_mont_right_spec;

fp2mul503_mont_same_ov <- verify fp2mul_mont_fun_name
    [ rdc_mont_ov
    , mul_asm_ov
    , mp_add434_asm_ov
    , mp_subadd434x2_asm_left_ov
    , mp_dblsub434x2_asm_ov
    ]
    fp2mul503_mont_same_spec;

fp2sqr503_mont_ov <- verify fp2sqr_mont_fun_name
    [ fpmul503_mont_ov
    , fpsub503_ov
    , mp_add434_asm_ov
    ]
    fp2sqr503_mont_spec;

fp2sqr503_mont_same_ov <- verify fp2sqr_mont_fun_name
    [ fpmul503_mont_ov
    , fpmul503_mont_right_ov
    , fpsub503_ov
    , mp_add434_asm_ov
    ]
    fp2sqr503_mont_same_spec;

fp2inv503_mont_ov <- verify fp2inv_mont_fun_name
    [ fpsqr503_mont_ov
    , fpadd503_left_ov
    , fpinv503_mont_ov
    , fpneg503_ov
    , fpmul503_mont_left_ov
    ]
    fp2inv503_mont_spec;

to_fp2mont_ov <- verify to_fp2mont_fun_name
    [to_mont_ov]
    to_fp2mont_spec;
to_fp2mont_same_ov <- verify to_fp2mont_fun_name
    [to_mont_same_ov]
    to_fp2mont_same_spec;
from_fp2mont_ov <- verify from_fp2mont_fun_name
    [from_mont_ov]
    from_fp2mont_spec;

